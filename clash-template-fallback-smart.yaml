# ========================
# Clash.Meta (OpenClash) 终极优化配置
# 架构：多机场合并 -> 业务分流 -> 故障转移(Fallback) -> [手动选择 + LightGBM 智选(Smart)]
# 面板：面板端口、UI及密码均已注释
# ========================

# 1. 机场节点订阅配置 (支持无限叠加多个机场)
proxy-providers:
  
  主用机场:
    url: "请在这里填入第1个机场的订阅地址"  
    type: http
    interval: 86400
    health-check:
      enable: true
      url: https://www.gstatic.com/generate_204
      interval: 300
    proxy: 直连

  备用机场:
    url: "请在这里填入第2个机场的订阅地址"  
    type: http
    interval: 86400
    health-check:
      enable: true
      url: https://www.gstatic.com/generate_204
      interval: 300
    proxy: 直连

  # 如果你有第三个、第四个机场，直接复制上面的格式粘贴在这里即可
  # 第三个机场:
  #   url: "..."
  #   ...

proxies:
  - {name: 直连, type: direct}
  - {name: 拒绝, type: reject}

# ========================
# 2. 核心端口与运行模式设置
# ========================
port: 7890
socks-port: 7891
redir-port: 7892
mixed-port: 7893
tproxy-port: 7895

allow-lan: true
mode: rule
log-level: info

# 下方控制面板端口、UI及密码已根据要求注释掉
# external-controller: 0.0.0.0:9090
# external-ui: ui
# external-ui-name: zashboard
# external-ui-url: https://gh-proxy.com/github.com/Zephyruso/zashboard/archive/refs/heads/gh-pages.zip
# secret: "123456"

# ========================
# 3. DNS 设置 (防止 DNS 泄露)
# ========================
dns:
  enable: true
  listen: 0.0.0.0:7874
  ipv6: true
  enhanced-mode: fake-ip
  fake-ip-range: 198.20.0.1/16
  nameserver:
    - 223.5.5.5
  fake-ip-filter-mode: blacklist
  fake-ip-filter:
    - +.lan
    - +.local
    - geosite:cn

# ========================
# 4. TUN 模块 
# ========================
tun:
  enable: true
  stack: gvisor
  device: utun
  endpoint-independent-nat: true
  auto-route: false
  auto-detect-interface: false

profile:
  store-selected: true
  store-fake-ip: true

# ========================
# 5. 策略组定义 (终极双层嵌套架构，自动融合多机场)
# ========================
default: &default
  type: select
  proxies:
    - 所有-故转
    - 香港-故转
    - 台湾-故转
    - 日本-故转
    - 新加坡-故转
    - 美国-故转
    - 印度-故转
    - 其他-故转
    - 直连
    - 拒绝

proxy-groups:

  # --- [第1层] 你的业务分流组 (极其清爽，只包含"故转"组) ---
  - {name: AI, <<: *default}
  - {name: Google, <<: *default}
  - {name: 海外社交, <<: *default}
  - {name: Telegram, <<: *default}
  - {name: EhGallery, <<: *default}
  - {name: Apple, <<: *default}
  - {name: Microsoft, <<: *default}
  - {name: NVIDIA, <<: *default}
  - {name: 国外流媒体, <<: *default}
  - {name: Emby, <<: *default}
  - {name: Spotify, <<: *default}
  - {name: 游戏平台, <<: *default}
  - {name: Test-国外, <<: *default}

  # --- 特殊分流组 ---
  - name: Test-国内
    type: select
    proxies:
      - 直连
      - 所有-故转
      - 香港-故转
      - 台湾-故转
      - 日本-故转
      - 新加坡-故转
      - 美国-故转
      - 印度-故转
      - 其他-故转
      - 拒绝

  - name: 国内
    type: select
    proxies:
      - 直连
      - 拒绝

  - name: 国外
    type: select
    proxies:
      - 香港-故转
      - 台湾-故转
      - 日本-故转
      - 新加坡-故转
      - 美国-故转
      - 印度-故转
      - 其他-故转
      - 所有-故转
      - 直连
      - 拒绝

  # --- [第2层 & 第3层] 故障转移、智选与手动组定义 ---
  
  # 【所有节点】
  - name: 所有-故转
    type: fallback
    interval: 300
    lazy: false
    proxies:
      - 所有-手动
      - 所有-智选
  - name: 所有-手动
    type: select
    include-all: true
    filter: "^((?!(直连|拒绝)).)*$"
  - name: 所有-智选
    type: smart
    include-all: true
    uselightgbm: true
    collectdata: true
    interval: 300
    filter: "^((?!(直连|拒绝)).)*$"

  # 【香港】
  - name: 香港-故转
    type: fallback
    interval: 300
    lazy: false
    proxies:
      - 香港-手动
      - 香港-智选
  - name: 香港-手动
    type: select
    include-all: true
    filter: "(广港|香港|HK|Hong Kong|HongKong)"
  - name: 香港-智选
    type: smart
    include-all: true
    uselightgbm: true
    collectdata: true
    interval: 300
    filter: "(广港|香港|HK|Hong Kong|HongKong)"

  # 【台湾】
  - name: 台湾-故转
    type: fallback
    interval: 300
    lazy: false
    proxies:
      - 台湾-手动
      - 台湾-智选
  - name: 台湾-手动
    type: select
    include-all: true
    filter: "(广台|台湾|台灣|TW|Tai Wan|TaiWan|Taiwan)"
  - name: 台湾-智选
    type: smart
    include-all: true
    uselightgbm: true
    collectdata: true
    interval: 300
    filter: "(广台|台湾|台灣|TW|Tai Wan|TaiWan|Taiwan)"

  # 【日本】
  - name: 日本-故转
    type: fallback
    interval: 300
    lazy: false
    proxies:
      - 日本-手动
      - 日本-智选
  - name: 日本-手动
    type: select
    include-all: true
    filter: "(广日|日本|JP|东京|大阪|泉日|埼玉|Japan)"
  - name: 日本-智选
    type: smart
    include-all: true
    uselightgbm: true
    collectdata: true
    interval: 300
    filter: "(广日|日本|JP|东京|大阪|泉日|埼玉|Japan)"

  # 【新加坡】
  - name: 新加坡-故转
    type: fallback
    interval: 300
    lazy: false
    proxies:
      - 新加坡-手动
      - 新加坡-智选
  - name: 新加坡-手动
    type: select
    include-all: true
    filter: "(广新|新加坡|SG|坡|狮城|Singapore)"
  - name: 新加坡-智选
    type: smart
    include-all: true
    uselightgbm: true
    collectdata: true
    interval: 300
    filter: "(广新|新加坡|SG|坡|狮城|Singapore)"

  # 【美国】
  - name: 美国-故转
    type: fallback
    interval: 300
    lazy: false
    proxies:
      - 美国-手动
      - 美国-智选
  - name: 美国-手动
    type: select
    include-all: true
    filter: "(广美|美国|US|纽约|达拉斯|凤凰城|拉斯维加斯|洛杉|圣何塞|西雅图|芝加哥|United States)"
  - name: 美国-智选
    type: smart
    include-all: true
    uselightgbm: true
    collectdata: true
    interval: 300
    filter: "(广美|美国|US|纽约|达拉斯|凤凰城|拉斯维加斯|洛杉|圣何塞|西雅图|芝加哥|United States)"

  # 【印度】
  - name: 印度-故转
    type: fallback
    interval: 300
    lazy: false
    proxies:
      - 印度-手动
      - 印度-智选
  - name: 印度-手动
    type: select
    include-all: true
    filter: "(印度|IN|India|班加罗尔|孟买|德里|加尔各答|清奈|浦那|斋浦尔|艾哈迈达巴德)"
  - name: 印度-智选
    type: smart
    include-all: true
    uselightgbm: true
    collectdata: true
    interval: 300
    filter: "(印度|IN|India|班加罗尔|孟买|德里|加尔各答|清奈|浦那|斋浦尔|艾哈迈达巴德)"

  # 【其他】
  - name: 其他-故转
    type: fallback
    interval: 300
    lazy: false
    proxies:
      - 其他-手动
      - 其他-智选
  - name: 其他-手动
    type: select
    include-all: true
    filter: "(广韩|韩国|韓國|KR|首尔|春川|Korea|英|法|德|澳|加拿大|俄|荷|瑞|越|泰|马|菲|以|墨|巴|阿联|土耳其|意|西|南非|巴西|阿根廷|葡萄牙|波兰|挪威|丹麦|捷克|奥地利|匈牙利|罗马尼亚|冰岛|爱尔兰|希腊|芬兰|卢森堡|比利时|乌克兰|哈萨克斯坦|俄罗斯|智利|沙特|新西兰|迪拜|UK|FR|DE|AU|CA|RU|United Kingdom|France|Germany|Australia|Canada|Russia|Moscow|Ireland|Sweden|Switzerland|Finland|Greece|Ukraine|Kazakhstan|UAE|Chile|New Zealand)"
  - name: 其他-智选
    type: smart
    include-all: true
    uselightgbm: true
    collectdata: true
    interval: 300
    filter: "(广韩|韩国|韓國|KR|首尔|春川|Korea|英|法|德|澳|加拿大|俄|荷|瑞|越|泰|马|菲|以|墨|巴|阿联|土耳其|意|西|南非|巴西|阿根廷|葡萄牙|波兰|挪威|丹麦|捷克|奥地利|匈牙利|罗马尼亚|冰岛|爱尔兰|希腊|芬兰|卢森堡|比利时|乌克兰|哈萨克斯坦|俄罗斯|智利|沙特|新西兰|迪拜|UK|FR|DE|AU|CA|RU|United Kingdom|France|Germany|Australia|Canada|Russia|Moscow|Ireland|Sweden|Switzerland|Finland|Greece|Ukraine|Kazakhstan|UAE|Chile|New Zealand)"


# ========================
# 6. 规则引擎 (Rules) - 无损保留
# ========================
rules:
  # 测速
  - RULE-SET,Test-Abroad,Test-国外
  - RULE-SET,Test-China,Test-国内
  
  # AI
  - RULE-SET,OpenAI,AI
  - RULE-SET,Claude,AI
  - RULE-SET,MetaAi,AI
  - RULE-SET,Perplexity,AI
  - RULE-SET,AI-ZA,AI

  # 谷歌
  - RULE-SET,Google-List,Google
  - RULE-SET,Gemini,Google
  - RULE-SET,YouTube,Google

  # 社交
  - RULE-SET,Telegram-List,Telegram
  - RULE-SET,EhGallery-List,EhGallery
  - RULE-SET,Twitter,海外社交
  - RULE-SET,Whatsapp,海外社交
  - RULE-SET,Facebook,海外社交
  - RULE-SET,TikTok,海外社交
  - RULE-SET,Instagram,海外社交
  - RULE-SET,Reddit,海外社交
  - RULE-SET,Discord,海外社交
  - RULE-SET,Twitch,海外社交
  - RULE-SET,GitHub,海外社交
  - RULE-SET,Custom-Social,海外社交

  # 电商厂商
  - RULE-SET,Apple-List,Apple
  - RULE-SET,Microsoft-List,Microsoft
  - RULE-SET,NVIDIA-List,NVIDIA

  # 流媒体
  - RULE-SET,Netflix,国外流媒体
  - RULE-SET,Disney,国外流媒体
  - RULE-SET,PrimeVideo,国外流媒体
  - RULE-SET,HBO,国外流媒体
  - RULE-SET,Popcorn,国外流媒体
  - RULE-SET,Emby-List,Emby
  - RULE-SET,Spotify-List,Spotify

  # 游戏
  - RULE-SET,Steam,游戏平台
  - RULE-SET,Epic,游戏平台
  - RULE-SET,EA,游戏平台

  # 国内应用与直连
  - RULE-SET,Download,国内
  - RULE-SET,PrivateTracker,国内
  - RULE-SET,ChinaMax,国内
  - RULE-SET,ChinaMedia,国内
  - RULE-SET,Lan,国内
  - GEOSITE,category-games@cn,国内
  - GEOSITE,category-game-platforms-download,国内
  - GEOSITE,category-public-tracker,国内
  - GEOSITE,cn,国内
  - GEOIP,CN,国内

  # 国外兜底
  - MATCH,国外

# ========================
# 7. 规则集提供者 (Rule-Providers) - 无损保留gh-proxy.org
# ========================
rule-anchor:
  class: &class {type: http, interval: 86400, behavior: classical, format: text}

rule-providers:
  # 国内
  Download: {<<: *class, url: "https://gh-proxy.org/raw.githubusercontent.com/blackmatrix7/ios_rule_script/master/rule/Clash/Download/Download.list"}
  PrivateTracker: {<<: *class, url: "https://gh-proxy.org/raw.githubusercontent.com/blackmatrix7/ios_rule_script/master/rule/Clash/PrivateTracker/PrivateTracker.list"}
  ChinaMax: {<<: *class, url: "https://gh-proxy.org/raw.githubusercontent.com/blackmatrix7/ios_rule_script/master/rule/Clash/ChinaMax/ChinaMax.list"}
  ChinaMedia: {<<: *class, url: "https://gh-proxy.org/raw.githubusercontent.com/blackmatrix7/ios_rule_script/master/rule/Clash/ChinaMedia/ChinaMedia.list"}
  Lan: {<<: *class, url: "https://gh-proxy.org/raw.githubusercontent.com/blackmatrix7/ios_rule_script/master/rule/Clash/Lan/Lan.list"}

  # 测速
  Test-Abroad: {<<: *class, url: "https://gh-proxy.org/raw.githubusercontent.com/aichenshidelibing/clash/refs/heads/main/speedtest-abroad.list"}
  Test-China: {<<: *class, url: "https://gh-proxy.org/raw.githubusercontent.com/aichenshidelibing/clash/refs/heads/main/speedtest-china.list"}

  # AI
  OpenAI: {<<: *class, url: "https://gh-proxy.org/raw.githubusercontent.com/blackmatrix7/ios_rule_script/master/rule/Clash/OpenAI/OpenAI.list"}
  Claude: {<<: *class, url: "https://gh-proxy.org/raw.githubusercontent.com/blackmatrix7/ios_rule_script/master/rule/Clash/Claude/Claude.list"}
  MetaAi: {<<: *class, url: "https://gh-proxy.org/raw.githubusercontent.com/aichenshidelibing/clash/refs/heads/main/MetaAi.list"}
  Perplexity: {<<: *class, url: "https://gh-proxy.org/raw.githubusercontent.com/aichenshidelibing/clash/refs/heads/main/Perplexity.list"}
  AI-ZA: {<<: *class, url: "https://gh-proxy.org/raw.githubusercontent.com/aichenshidelibing/clash/refs/heads/main/AI-ZA.list"}

  # 谷歌
  Google-List: {<<: *class, url: "https://gh-proxy.org/raw.githubusercontent.com/blackmatrix7/ios_rule_script/master/rule/Clash/Google/Google.list"}
  Gemini: {<<: *class, url: "https://gh-proxy.org/raw.githubusercontent.com/aichenshidelibing/clash/refs/heads/main/Gemini.list"}
  YouTube: {<<: *class, url: "https://gh-proxy.org/raw.githubusercontent.com/blackmatrix7/ios_rule_script/master/rule/Clash/YouTube/YouTube.list"}

  # 社交
  Telegram-List: {<<: *class, url: "https://gh-proxy.org/raw.githubusercontent.com/blackmatrix7/ios_rule_script/master/rule/Clash/Telegram/Telegram.list"}
  EhGallery-List: {<<: *class, url: "https://gh-proxy.org/raw.githubusercontent.com/aichenshidelibing/clash/refs/heads/main/EhGallery.list"}
  Twitter: {<<: *class, url: "https://gh-proxy.org/raw.githubusercontent.com/blackmatrix7/ios_rule_script/master/rule/Clash/Twitter/Twitter.list"}
  Whatsapp: {<<: *class, url: "https://gh-proxy.org/raw.githubusercontent.com/blackmatrix7/ios_rule_script/master/rule/Clash/Whatsapp/Whatsapp.list"}
  Facebook: {<<: *class, url: "https://gh-proxy.org/raw.githubusercontent.com/blackmatrix7/ios_rule_script/master/rule/Clash/Facebook/Facebook.list"}
  TikTok: {<<: *class, url: "https://gh-proxy.org/raw.githubusercontent.com/blackmatrix7/ios_rule_script/master/rule/Clash/TikTok/TikTok.list"}
  Instagram: {<<: *class, url: "https://gh-proxy.org/raw.githubusercontent.com/blackmatrix7/ios_rule_script/master/rule/Clash/Instagram/Instagram.list"}
  Reddit: {<<: *class, url: "https://gh-proxy.org/raw.githubusercontent.com/blackmatrix7/ios_rule_script/master/rule/Clash/Reddit/Reddit.list"}
  Custom-Social: {<<: *class, url: "https://gh-proxy.org/raw.githubusercontent.com/aichenshidelibing/clash/refs/heads/main/251120.list"}
  Discord: {<<: *class, url: "https://gh-proxy.org/raw.githubusercontent.com/blackmatrix7/ios_rule_script/master/rule/Clash/Discord/Discord.list"}
  Twitch: {<<: *class, url: "https://gh-proxy.org/raw.githubusercontent.com/blackmatrix7/ios_rule_script/master/rule/Clash/Twitch/Twitch.list"}
  GitHub: {<<: *class, url: "https://gh-proxy.org/raw.githubusercontent.com/blackmatrix7/ios_rule_script/master/rule/Clash/GitHub/GitHub.list"}

  # 电商/厂商
  Apple-List: {<<: *class, url: "https://gh-proxy.org/raw.githubusercontent.com/blackmatrix7/ios_rule_script/master/rule/Clash/Apple/Apple.list"}
  Microsoft-List: {<<: *class, url: "https://gh-proxy.org/raw.githubusercontent.com/blackmatrix7/ios_rule_script/master/rule/Clash/Microsoft/Microsoft.list"}
  NVIDIA-List: {<<: *class, url: "https://gh-proxy.org/raw.githubusercontent.com/blackmatrix7/ios_rule_script/master/rule/Clash/NVIDIA/NVIDIA.list"}

  # 流媒体
  Netflix: {<<: *class, url: "https://gh-proxy.org/raw.githubusercontent.com/blackmatrix7/ios_rule_script/master/rule/Clash/Netflix/Netflix.list"}
  Disney: {<<: *class, url: "https://gh-proxy.org/raw.githubusercontent.com/blackmatrix7/ios_rule_script/master/rule/Clash/Disney/Disney.list"}
  PrimeVideo: {<<: *class, url: "https://gh-proxy.org/raw.githubusercontent.com/blackmatrix7/ios_rule_script/master/rule/Clash/PrimeVideo/PrimeVideo.list"}
  HBO: {<<: *class, url: "https://gh-proxy.org/raw.githubusercontent.com/blackmatrix7/ios_rule_script/master/rule/Clash/HBO/HBO.list"}
  Popcorn: {<<: *class, url: "https://gh-proxy.org/raw.githubusercontent.com/liandu2024/clash/refs/heads/main/list/Popcorn.list"}
  Emby-List: {<<: *class, url: "https://gh-proxy.org/raw.githubusercontent.com/aichenshidelibing/clash/refs/heads/main/EMBY.list"}
  Spotify-List: {<<: *class, url: "https://gh-proxy.org/raw.githubusercontent.com/blackmatrix7/ios_rule_script/master/rule/Clash/Spotify/Spotify.list"}

  # 游戏平台与端
  Steam: {<<: *class, url: "https://gh-proxy.org/raw.githubusercontent.com/blackmatrix7/ios_rule_script/master/rule/Clash/Steam/Steam.list"}
  Epic: {<<: *class, url: "https://gh-proxy.org/raw.githubusercontent.com/blackmatrix7/ios_rule_script/master/rule/Clash/Epic/Epic.list"}
  EA: {<<: *class, url: "https://gh-proxy.org/raw.githubusercontent.com/blackmatrix7/ios_rule_script/master/rule/Clash/EA/EA.list"}